<project name="conjure" default="all">

  <description>
    Build with "ant" and then generate a conjure 
    project with java -jar conjure.jar *project name*
  </description>

  <property name="src" location="src"/>
  <property name="vendor" location="vendor"/>
  <property name="test" location="test"/>
  <property name="conjure_src" location="${vendor}/conjure"/>
  <property name="target" location="target"/>
  <property name="classes" location="${target}/classes"/>
  <property name="test_app" location="${target}/test_app"/>

  <property name="file_structure" location="file_structure"/>
  <property name="default" location="${filestructure}/default"/>

  <target name="compile-conjure"
          description="Compile Conjure sources.">
    <mkdir dir="${classes}" />
    <javac srcdir="${src}"
           destdir="${classes}"
           debug="on"
    />
  </target>

  <target name="jar" depends="compile-conjure">
    <jar destfile="${target}/conjure.jar">
      <fileset dir="${classes}"/>
      <fileset dir="${file_structure}"/>
      <manifest>
        <attribute name="Main-Class" value="conjure.Main"/>
      </manifest>
    </jar>
  </target>

  <target name="all" depends="jar, test"/>

  <target name="clean"
          description="Remove autogenerated files and directories.">
    <delete dir="${target}"/>
  </target>

  <target name="test" depends="jar" description="Run all of the tests for Conjure.">
    <java jar="${target}/conjure.jar" fork="true" dir="${target}">
      <arg value="test_app"/>
    </java>
    <copy todir="${target}/test_app/test">
      <fileset dir="${test}"/>
    </copy>
  	<java classname="clojure.lang.Script" dir="${test_app}" fork="true">
      <arg value="test/run_tests.clj"/>
      <classpath>
      	<pathelement path="${test_app}/vendor"/>
      	<pathelement path="${test_app}/app"/>
      	<pathelement path="${test_app}/config"/>
      	<pathelement path="${test_app}/script"/>
      	<pathelement path="${test_app}/db"/>
      	<pathelement path="${test_app}/test"/>
      	<fileset dir="${test_app}/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
  	</java>
  </target>
	
</project>
